# RustDesk 编译时服务器配置指南

本文档详细介绍如何使用 `compile_time_config.rs` 文件在编译时设置RustDesk客户端的服务器配置，使客户端默认连接到指定服务器并限制用户修改这些配置。

## 为什么需要编译时配置？

在企业环境或特定部署场景中，您可能希望：

1. 确保客户端默认连接到您自己的RustDesk服务器，而不是官方公共服务器
2. 防止用户修改服务器设置，确保连接安全和管理可控
3. 简化用户体验，用户无需手动配置服务器信息
4. 定制客户端的显示名称，表明这是一个企业或组织定制的版本

## 配置文件结构

`compile_time_config.rs` 文件包含以下主要部分：

1. **配置结构体定义**：定义了存储服务器配置信息的数据结构
2. **配置常量**：您需要修改的服务器信息常量
3. **配置初始化逻辑**：将编译时配置应用到RustDesk全局配置的代码
4. **线程安全的初始化保证**：确保配置只被初始化一次的机制

## 如何修改配置

### 1. 服务器地址设置

```rust
// 自定义服务器地址（必填）
// 修改效果：客户端启动时会自动连接到此服务器
// 格式：服务器域名或IP地址:端口号（默认端口为21117）
const CUSTOM_RENDEZVOUS_SERVER: &str = "your-server.com:21117";
```

**修改方法**：将 `"your-server.com:21117"` 替换为您的RustDesk服务器地址和端口号。

**修改效果**：编译后的客户端启动时会自动连接到您指定的服务器，无需用户手动配置。

### 2. 中继服务器设置

```rust
// 自定义中继服务器地址（可选）
// 修改效果：设置客户端使用的中继服务器，若留空则使用服务器自动分配的中继
// 格式：服务器域名或IP地址:端口号（默认端口为21117）
const CUSTOM_RELAY_SERVER: &str = "your-server.com:21117";
```

**修改方法**：将 `"your-server.com:21117"` 替换为您的中继服务器地址和端口号。如果留空（即 `""`），则使用服务器自动分配的中继服务器。

**修改效果**：当P2P连接失败时，客户端会使用您指定的中继服务器进行连接。

### 3. API服务器设置

```rust
// 自定义API服务器地址（可选）
// 修改效果：设置客户端连接的API服务器，用于用户认证和管理功能
// 格式：服务器域名或IP地址:端口号（默认端口为21114）
const CUSTOM_API_SERVER: &str = "your-server.com:21114";
```

**修改方法**：将 `"your-server.com:21114"` 替换为您的API服务器地址和端口号。如果留空（即 `""`），则使用默认的API服务器设置。

**修改效果**：客户端会使用您指定的API服务器进行用户认证、设备管理等功能。

### 4. 服务器公钥设置

```rust
// 自定义服务器公钥（必填）
// 修改效果：设置用于加密通信的服务器公钥，确保连接安全性
// 格式：Base64编码的公钥字符串
const CUSTOM_KEY: &str = "your-public-key-here";
```

**修改方法**：将 `"your-public-key-here"` 替换为您的RustDesk服务器的公钥。这个公钥可以在服务器端生成，通常是一个Base64编码的字符串。

**修改效果**：客户端会使用此公钥与服务器建立安全连接，确保通信加密和服务器身份验证。

### 5. 客户端显示名称设置

在 `init_compile_time_config()` 函数中有以下代码：

```rust
// 设置为自定义客户端
// 修改效果：更改客户端的显示名称，表明这是一个定制版本
*config::APP_NAME.write().unwrap() = "RustDesk Custom";
```

**修改方法**：将 `"RustDesk Custom"` 替换为您想要显示的客户端名称。

**修改效果**：编译后的客户端将显示您自定义的名称，而不是默认的"RustDesk"。

## 配置锁定机制

该配置系统不仅设置了默认的服务器信息，还通过以下方式锁定了这些设置，防止用户修改：

```rust
// 以下代码将服务器配置添加到HARD_SETTINGS中，防止用户在界面上修改这些设置
// 修改效果：锁定服务器相关设置，用户无法在客户端界面更改这些配置
config::HARD_SETTINGS
    .write()
    .unwrap()
    .insert(config::keys::OPTION_CUSTOM_RENDEZVOUS_SERVER.to_string(), config.rendezvous_server.clone());

// 类似代码也应用于中继服务器、API服务器和密钥设置
```

这意味着即使有用户尝试通过客户端界面修改服务器设置，这些修改也不会生效，客户端将始终使用您在编译时设置的服务器信息。

## 编译和部署

完成配置修改后，您可以按照常规的RustDesk编译流程进行编译。编译后的客户端将包含您的自定义服务器设置，用户无需进行任何配置即可连接到您的服务器。

## 注意事项

1. 请确保您的服务器地址、端口和公钥正确无误，否则客户端将无法连接到服务器
2. 如果您的服务器设置发生变化，您需要重新编译客户端以应用新的设置
3. 此配置方法只影响编译后的客户端行为，不会影响服务器端的配置
4. 这种编译时配置方式比通过修改默认值更灵活，可以在不修改原有代码的情况下设置自定义服务器信息

## 高级定制选项

如果您需要进一步定制RustDesk客户端，您可以：

1. 修改 `init_compile_time_config()` 函数中的其他配置项
2. 参考 `hbb_common::config` 模块了解更多可配置选项
3. 根据您的需求添加更多的编译时配置项

通过这种方式，您可以创建完全符合您组织需求的定制版RustDesk客户端。